# MCP服务器开发最佳实践

本文档提供了模型上下文协议（MCP）服务器开发的全面最佳实践指南。遵循这些实践可以确保您的MCP服务器具有高质量、可靠性和良好的用户体验。

## 概述

MCP服务器最佳实践涵盖以下关键领域：

- **工具设计**: 如何设计有效的工具接口
- **安全考虑**: 确保服务器的安全性和稳定性
- **错误处理**: 适当的错误处理和用户反馈
- **性能优化**: 优化响应时间和资源使用
- **测试策略**: 全面的测试方法

## 工具设计原则

### 以工作流为中心的设计

MCP服务器应该围绕完整的工作流设计，而不是简单地包装API端点。考虑用户完成特定任务所需的完整操作序列。

**良好设计示例**:
- 项目管理工具：创建项目 → 添加任务 → 分配成员 → 跟踪进度
- 数据分析工具：导入数据 → 清理数据 → 分析数据 → 生成报告

**避免的设计**:
- 简单的CRUD操作包装器
- 没有逻辑关联的独立工具集合

### 工具命名策略

工具名称应该反映自然的任务划分：

- **使用动词-名词格式**: `create_project`, `analyze_data`, `generate_report`
- **避免技术术语**: 使用业务领域语言而非技术实现细节
- **保持一致性**: 相似功能的工具使用统一的命名模式

### 响应格式优化

设计响应格式以优化代理上下文效率：

- **结构化数据**: 使用表格、列表等结构化格式
- **简洁摘要**: 提供关键信息的简洁摘要
- **渐进式细节**: 从概要到详细信息的渐进式展示
- **可读性优先**: 确保人类和机器都能理解

## 输入参数设计

### 参数命名和描述

为每个参数提供清晰、描述性的名称和文档：

```typescript
{
  name: "project_id",
  description: "要查询的项目的唯一标识符",
  type: "string",
  required: true
}
```

### 参数验证

实现严格的参数验证：

- **类型检查**: 确保参数类型正确
- **范围验证**: 验证数值在有效范围内
- **格式验证**: 检查字符串格式（如URL、邮箱等）
- **必需性检查**: 验证必需参数是否提供

### 默认值和可选参数

合理使用默认值和可选参数：

```typescript
{
  name: "page_size",
  description: "每页返回的结果数量",
  type: "number",
  required: false,
  default: 50,
  minimum: 1,
  maximum: 1000
}
```

## 工具响应设计

### 响应格式

设计清晰、结构化的响应格式：

```typescript
// 良好响应示例
{
  summary: "找到15个匹配的项目",
  items: [
    { id: "1", name: "项目A", status: "进行中" },
    { id: "2", name: "项目B", status: "已完成" }
  ],
  total_count: 15,
  next_page_token: "abc123"
}
```

### 错误响应

提供清晰、可操作的错误信息：

```typescript
// 良好错误响应示例
{
  isError: true,
  content: [
    {
      type: "text",
      text: "错误：项目ID 'invalid_id' 不存在。请检查项目ID是否正确。"
    }
  ]
}
```

## 安全考虑

### 输入验证

暴露工具时的安全考虑：

- **验证所有参数**: 根据schema验证所有参数
- **清理文件路径和系统命令**: 防止路径遍历和命令注入
- **验证URL和外部标识符**: 确保外部资源的安全性
- **检查参数大小和范围**: 防止资源耗尽攻击
- **防止命令注入**: 对用户输入进行适当清理

### 访问控制

- **实现认证**: 在需要时实现适当的认证机制
- **使用授权检查**: 确保用户有权执行操作
- **审计工具使用**: 记录工具使用情况用于安全审计
- **速率限制请求**: 防止滥用和拒绝服务攻击
- **监控滥用行为**: 检测和响应可疑活动

### 错误处理安全

- **不要向客户端暴露内部错误**: 避免信息泄露
- **记录安全相关错误**: 用于安全分析和调查
- **适当处理超时**: 防止资源泄漏
- **错误后清理资源**: 确保系统稳定性
- **验证返回值**: 防止数据污染

## 工具发现和更新

MCP支持动态工具发现：

1. **客户端可以随时列出可用工具**
2. **服务器可以使用`notifications/tools/list_changed`通知客户端工具变更**
3. **工具可以在运行时添加或移除**
4. **工具定义可以更新**（但应谨慎进行）

## 错误处理

工具错误应该在结果对象内报告，而不是作为MCP协议级错误。这允许LLM看到并可能处理错误。当工具遇到错误时：

1. 在结果中将`isError`设置为`true`
2. 在`content`数组中包含错误详情

以下是工具正确错误处理的示例：

```typescript
try {
  // 工具操作
  const result = performOperation();
  return {
    content: [
      {
        type: "text",
        text: `操作成功: ${result}`
      }
    ]
  };
} catch (error) {
  return {
    isError: true,
    content: [
      {
        type: "text",
        text: `错误: ${error.message}`
      }
    ]
  };
}
```

这种方法允许LLM看到发生了错误，并可能采取纠正措施或请求人工干预。

## 工具注解

工具注解提供关于工具行为的额外元数据，帮助客户端理解如何呈现和管理工具。这些注解是描述工具性质和影响的提示，但不应用于安全决策。

### 工具注解的目的

工具注解服务于几个关键目的：

1. **提供UX特定信息**而不影响模型上下文
2. **帮助客户端适当分类和呈现工具**
3. **传达工具潜在副作用的信息**
4. **协助开发直观的工具批准界面**

### 可用的工具注解

MCP规范为工具定义了以下注解：

| 注解 | 类型 | 默认值 | 描述 |
|------|------|--------|------|
| `title` | string | - | 工具的人类可读标题，用于UI显示 |
| `readOnlyHint` | boolean | false | 如果为true，表示工具不修改其环境 |
| `destructiveHint` | boolean | true | 如果为true，工具可能执行破坏性更新（仅在`readOnlyHint`为false时有意义） |
| `idempotentHint` | boolean | false | 如果为true，使用相同参数重复调用工具没有额外效果（仅在`readOnlyHint`为false时有意义） |
| `openWorldHint` | boolean | true | 如果为true，工具可能与"开放世界"的外部实体交互 |

### 示例用法

以下是如何为不同场景定义带注解的工具：

```typescript
// 只读搜索工具
{
  name: "web_search",
  description: "搜索网络信息",
  inputSchema: {
    type: "object",
    properties: {
      query: { type: "string" }
    },
    required: ["query"]
  },
  annotations: {
    title: "网络搜索",
    readOnlyHint: true,
    openWorldHint: true
  }
}

// 破坏性文件删除工具
{
  name: "delete_file",
  description: "从文件系统中删除文件",
  inputSchema: {
    type: "object",
    properties: {
      path: { type: "string" }
    },
    required: ["path"]
  },
  annotations: {
    title: "删除文件",
    readOnlyHint: false,
    destructiveHint: true,
    idempotentHint: true,
    openWorldHint: false
  }
}

// 非破坏性数据库记录创建工具
{
  name: "create_record",
  description: "在数据库中创建新记录",
  inputSchema: {
    type: "object",
    properties: {
      table: { type: "string" },
      data: { type: "object" }
    },
    required: ["table", "data"]
  },
  annotations: {
    title: "创建数据库记录",
    readOnlyHint: false,
    destructiveHint: false,
    idempotentHint: false,
    openWorldHint: false
  }
}
```

### 在服务器实现中集成注解

```typescript
server.setRequestHandler(ListToolsRequestSchema, async () => {
  return {
    tools: [{
      name: "calculate_sum",
      description: "将两个数字相加",
      inputSchema: {
        type: "object",
        properties: {
          a: { type: "number" },
          b: { type: "number" }
        },
        required: ["a", "b"]
      },
      annotations: {
        title: "计算总和",
        readOnlyHint: true,
        openWorldHint: false
      }
    }]
  };
});
```

### 工具注解的最佳实践

1. **准确描述副作用**: 清楚表明工具是否修改其环境以及这些修改是否具有破坏性。

2. **使用描述性标题**: 提供人类友好的标题，清楚描述工具的目的。

3. **正确指示幂等性**: 仅当使用相同参数重复调用工具确实没有额外效果时，才将工具标记为幂等。

4. **设置适当的开放/封闭世界提示**: 指示工具是与封闭系统（如数据库）还是开放系统（如网络）交互。

5. **记住注解是提示**: ToolAnnotations中的所有属性都是提示，不能保证提供工具行为的忠实描述。客户端绝不应仅基于注解做出安全关键决策。

## 测试工具

MCP工具的全面测试策略应涵盖：

* **功能测试**: 验证工具使用有效输入正确执行，并适当处理无效输入
* **集成测试**: 使用真实和模拟的依赖项测试工具与外部系统的交互
* **安全测试**: 验证认证、授权、输入清理和速率限制
* **性能测试**: 检查负载下的行为、超时处理和资源清理
* **错误处理**: 确保工具通过MCP协议正确报告错误并清理资源

## 性能优化

### 响应时间优化

- **缓存频繁访问的数据**: 实现适当的缓存策略
- **异步处理**: 对耗时操作使用异步处理
- **批量操作**: 支持批量处理提高效率
- **分页支持**: 对大型数据集实现分页

### 资源管理

- **连接池**: 对数据库和外部服务使用连接池
- **内存管理**: 合理管理内存使用，避免泄漏
- **文件处理**: 适当处理文件句柄和流
- **超时设置**: 设置合理的超时值

## 代码质量

### 代码可组合性和可重用性

您的实现必须优先考虑可组合性和代码重用：

1. **提取公共功能**:
   - 为跨多个工具使用的操作创建可重用的辅助函数
   - 构建用于HTTP请求的共享API客户端，而不是重复代码
   - 在实用函数中集中错误处理逻辑
   - 提取可以组合的专用业务逻辑函数
   - 提取共享的markdown或JSON字段选择和格式化功能

2. **避免重复**:
   - 绝不要在工具之间复制粘贴相似代码
   - 如果发现编写相似逻辑两次，将其提取到函数中
   - 分页、过滤、字段选择和格式化等常见操作应共享
   - 认证/授权逻辑应集中化

## 部署和运维

### 监控和日志

- **结构化日志**: 使用结构化日志格式便于分析
- **性能指标**: 收集响应时间、错误率等指标
- **健康检查**: 实现健康检查端点
- **警报设置**: 配置关键指标的警报

### 可扩展性

- **水平扩展**: 设计支持多实例部署
- **状态管理**: 对需要状态的操作使用外部存储
- **负载均衡**: 支持负载均衡器后的部署
- **配置管理**: 使用环境变量或配置文件

## 版本管理

### 向后兼容性

- **避免破坏性变更**: 尽量保持接口的向后兼容性
- **弃用策略**: 对计划移除的功能提供弃用警告
- **版本标识**: 在工具响应中包含版本信息

### 升级策略

- **渐进式部署**: 使用金丝雀部署等策略
- **回滚计划**: 准备快速回滚的方案
- **变更日志**: 维护详细的变更日志

## 总结

遵循这些最佳实践将帮助您构建高质量、可靠且用户友好的MCP服务器。关键要点包括：

1. **以用户为中心的设计**: 围绕真实工作流设计工具
2. **安全第一**: 实现强大的安全控制和输入验证
3. **清晰的文档**: 提供全面的工具文档和示例
4. **全面的测试**: 覆盖功能、安全、性能和错误场景
5. **持续改进**: 基于用户反馈和监控数据迭代改进

通过系统性地应用这些实践，您可以创建在真实世界场景中表现良好的MCP服务器，为最终用户提供出色的体验。